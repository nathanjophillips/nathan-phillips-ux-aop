<link rel="import" href="~@banno/polymer/polymer-element.html">
<link rel="import" href="~@banno/polymer/lib/elements/dom-if.html">
<link rel="import" href="./user-list.html">

<dom-module id="intern-app">
 <template>
   <style>
     h1 {
       background-color: indigo;
       color: #fcfcff;
       padding: 14px 25px;
       margin: 0px;
       text-align: center;
     }

     button {
       background-color: DarkSlateBlue;
       color: #fcfcff;
       border-radius: 3px;
       text-align: center;
       padding: 12px;
       margin-top: 20px;
       font-size: 12px;
     }

     label {
       margin-top: 25px;
       padding-right: 5px;
     }

     input {
       font-size: 18px;
       border: 0;
       border-bottom: 1px solid indigo;
       background: transparent;
     }

     .add-button {
       background-color: #fca902;
       box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
       padding: 20px;
       font-size: 18px;
       padding-right: 40px;
       padding-left: 40px;
       text-align: center;
       margin-bottom: 10px;
     }

     .delete-all-button {
       background-color: #d1250ee3;
       box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
     }
   </style>
   <header>
     <h1>Intern App</h1>
   </header>
   <template is="dom-if" if="[[!addUserSelected]]">
     <button class="add-button" type="button" on-click="createNewUserProfile">[[changeButtonText(addUserSelected)]]</button>
   </template>
   <user-list user-profiles="[[userProfiles]]" add-user-selected="[[addUserSelected]]"></user-list>
   <template is="dom-if" if="[[cardsPopulated]]">
      <button class="delete-all-button" type="button" on-click="deleteAll">Delete All Users</button>
   </template>
 </template>
 <script type="module">
   'use strict';
   import localStorageApi from "../api/local-storage.js";
   class InternApp extends Polymer.Element {
     static get is() { return 'intern-app'; }

     static get properties() {
       return {
         userProfiles: {
           type: Array,
           value: () => localStorageApi.getUsers()
         },
         addUserSelected: {
           type: Boolean,
           value: false
         },
         cardsPopulated: {
            type: Boolean,
            value: false
         }
       }
     }

     constructor() {
       super();
       this.boundNewUser = this.newUser.bind(this);
     }

     connectedCallback() {
       super.connectedCallback();
       window.addEventListener("newUser", this.boundNewUser);
     }

     disconnectedCallback() {
       super.disconnectedCallback();
       window.removeEventListener("newUser", this.boundNewUser);
     }

     deleteAll() {
      if (window.confirm("Are you sure you want to delete all users?")) {
        localStorageApi.deleteUsers();
        cardsPopulated = false;
        }  
      } 

     newUser(event) {
       const newUserProfile = Object.assign({},event.detail);
       newUserProfile.id = localStorageApi.genId();
       this.pushToArray(this.userProfiles, newUserProfile);
       this.addUserSelected = false;
       this.cardsPopulated = true;
     }

     pushToArray(userProfiles, newUserProfile) {
       const existingIds = userProfiles.map(newUserProfile => newUserProfile.id); 
       const validUser = localStorageApi.validateUser(newUserProfile);
       if (validUser) {
         localStorageApi.createUser(newUserProfile);
         this.push('userProfiles', newUserProfile);
       }
       else {
         this.pushToArray(this.userProfiles, newUserProfile);
       };
     }

     createNewUserProfile(event) {
       this.addUserSelected = !this.addUserSelected;
     }

     changeButtonText(addUserSelected) {
       return addUserSelected ? `Save` : `Create User`;
     }
   }
   customElements.define(InternApp.is, InternApp);
   export default InternApp;
 </script>
</dom-module>
